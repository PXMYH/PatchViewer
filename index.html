<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Git Patch Viewer</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8f9fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .file-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .file-input {
            padding: 8px 12px;
            border: 2px dashed #ddd;
            border-radius: 4px;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }

        .clear-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .clear-btn:hover {
            background: #c0392b;
        }

        .result-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .file-header {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 15px 20px;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-name {
            font-weight: 600;
            font-size: 16px;
            color: #2c3e50;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .copy-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .diff-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.4;
        }

        .diff-row {
            border: none;
        }

        .line-number {
            width: 50px;
            padding: 4px 8px;
            text-align: right;
            background: #fafbfc;
            border-right: 1px solid #e1e4e8;
            color: #586069;
            user-select: none;
            font-size: 11px;
        }

        .diff-content {
            padding: 2px 8px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .diff-context {
            background: white;
            color: #24292e;
        }

        .diff-added {
            background: #e6ffed;
            color: #22863a;
        }

        .diff-removed {
            background: #ffeef0;
            color: #cb2431;
        }

        .diff-modified-old {
            background: #fff5b4;
            color: #735c0f;
        }

        .diff-modified-new {
            background: #d4edda;
            color: #155724;
        }

        .diff-header {
            background: #f1f8ff;
            color: #586069;
            font-weight: 600;
        }

        .diff-section {
            background: #f8f9fa;
            color: #6a737d;
            font-style: italic;
        }

        .stats {
            padding: 10px 20px;
            background: #f8f9fa;
            font-size: 14px;
            color: #586069;
            border-bottom: 1px solid #e1e4e8;
        }

        .file-navigation {
            background: #f8f9fa;
            padding: 10px 20px;
            border-bottom: 1px solid #e1e4e8;
        }

        .nav-select {
            padding: 6px 10px;
            border: 1px solid #d1d5da;
            border-radius: 4px;
            background: white;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #586069;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6a737d;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #586069;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .file-header {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .diff-table {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Git Patch Viewer</h1>
            <p>Upload and view git patches with syntax highlighting and side-by-side comparison</p>
            
            <div class="file-input-container">
                <input type="file" id="patchFile" class="file-input" accept=".patch,.diff" />
                <button id="clearBtn" class="clear-btn" style="display: none;">Clear</button>
            </div>
        </div>

        <div id="result" class="result-container">
            <div class="empty-state">
                <h3>No patch loaded</h3>
                <p>Select a .patch or .diff file to get started</p>
            </div>
        </div>
    </div>

    <script>
        class PatchViewer {
            constructor() {
                this.patchFile = document.getElementById('patchFile');
                this.clearBtn = document.getElementById('clearBtn');
                this.result = document.getElementById('result');
                
                this.initEventListeners();
            }

            initEventListeners() {
                this.patchFile.addEventListener('change', (e) => this.handleFileLoad(e));
                this.clearBtn.addEventListener('click', () => this.clearResult());
            }

            handleFileLoad(event) {
                const file = event.target.files[0];
                if (!file) return;

                this.showLoading();
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        this.parsePatch(e.target.result);
                        this.clearBtn.style.display = 'block';
                    } catch (error) {
                        this.showError('Error parsing patch file: ' + error.message);
                    }
                };
                reader.onerror = () => this.showError('Error reading file');
                reader.readAsText(file);
            }

            showLoading() {
                this.result.innerHTML = '<div class="loading">üìÑ Loading patch...</div>';
            }

            showError(message) {
                this.result.innerHTML = `<div class="error">${message}</div>`;
            }

            clearResult() {
                this.result.innerHTML = `
                    <div class="empty-state">
                        <h3>No patch loaded</h3>
                        <p>Select a .patch or .diff file to get started</p>
                    </div>
                `;
                this.patchFile.value = '';
                this.clearBtn.style.display = 'none';
            }

            parsePatch(content) {
                const files = this.splitIntoFiles(content);
                
                if (files.length === 0) {
                    this.showError('No valid patch data found in file');
                    return;
                }

                this.renderPatchFiles(files);
                this.addNavigation(files);
            }

            splitIntoFiles(content) {
                const lines = content.split('\n');
                const files = [];
                let currentFile = null;
                let currentHunk = null;

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];

                    // New file indicators
                    if (line.startsWith('diff --git') || line.startsWith('Index:')) {
                        if (currentFile) files.push(currentFile);
                        currentFile = { 
                            name: this.extractFileName(line, lines, i),
                            hunks: [],
                            stats: { added: 0, removed: 0 }
                        };
                        currentHunk = null;
                    }
                    // Hunk header
                    else if (line.startsWith('@@')) {
                        if (currentFile) {
                            currentHunk = { 
                                header: line,
                                lines: []
                            };
                            currentFile.hunks.push(currentHunk);
                        }
                    }
                    // Content lines
                    else if (currentHunk && (line.startsWith('+') || line.startsWith('-') || line.startsWith(' '))) {
                        const type = line.charAt(0);
                        const content = line.substring(1);
                        
                        currentHunk.lines.push({ type, content });
                        
                        if (type === '+') currentFile.stats.added++;
                        else if (type === '-') currentFile.stats.removed++;
                    }
                    // File path lines (fallback)
                    else if (line.startsWith('---') || line.startsWith('+++')) {
                        if (currentFile && !currentFile.name) {
                            currentFile.name = this.extractFileNameFromPath(line);
                        }
                    }
                }

                if (currentFile) files.push(currentFile);
                return files.filter(f => f.name && f.hunks.length > 0);
            }

            extractFileName(line, lines, index) {
                // Try git diff format first
                const gitMatch = line.match(/diff --git a\/(.*?) b\/(.*)/);
                if (gitMatch) return gitMatch[2];

                // Try Index format
                const indexMatch = line.match(/Index: (.*)/);
                if (indexMatch) return indexMatch[1];

                // Look ahead for file paths
                for (let i = index + 1; i < Math.min(index + 5, lines.length); i++) {
                    const nextLine = lines[i];
                    if (nextLine.startsWith('+++')) {
                        const pathMatch = nextLine.match(/\+\+\+ (.*)$/);
                        if (pathMatch && pathMatch[1] !== '/dev/null') {
                            return pathMatch[1].replace(/^\w\//, ''); // Remove a/ or b/ prefix
                        }
                    }
                }

                return 'Unknown';
            }

            extractFileNameFromPath(line) {
                const match = line.match(/^[\+\-]{3} (.*)$/);
                if (match && match[1] !== '/dev/null') {
                    return match[1].replace(/^\w\//, '');
                }
                return null;
            }

            renderPatchFiles(files) {
                let html = '';

                if (files.length > 1) {
                    html += this.renderNavigation(files);
                }

                files.forEach((file, index) => {
                    html += this.renderFile(file, index);
                });

                this.result.innerHTML = html;
                this.addCopyListeners();
            }

            renderNavigation(files) {
                const options = files.map((file, index) => 
                    `<option value="#file-${index}">${file.name}</option>`
                ).join('');

                return `
                    <div class="file-navigation">
                        <select class="nav-select" onchange="document.location.hash = this.value">
                            <option value="">Jump to file...</option>
                            ${options}
                        </select>
                    </div>
                `;
            }

            renderFile(file, index) {
                const totalChanges = file.stats.added + file.stats.removed;
                const statsText = totalChanges > 0 ? 
                    `+${file.stats.added} -${file.stats.removed} (${totalChanges} changes)` : 
                    'No changes';

                return `
                    <div id="file-${index}" class="file-section">
                        <div class="file-header">
                            <span class="file-name">${file.name}</span>
                            <button class="copy-btn" data-file-index="${index}">üìã Copy</button>
                        </div>
                        <div class="stats">${statsText}</div>
                        ${this.renderTable(file)}
                    </div>
                `;
            }

            renderTable(file) {
                let leftLine = 0;
                let rightLine = 0;
                let rows = '';

                file.hunks.forEach(hunk => {
                    // Parse hunk header to get line numbers
                    const hunkMatch = hunk.header.match(/@@ -(\d+)(?:,\d+)? \+(\d+)(?:,\d+)? @@(.*)/);
                    if (hunkMatch) {
                        leftLine = parseInt(hunkMatch[1]);
                        rightLine = parseInt(hunkMatch[2]);
                        
                        // Add hunk header row
                        const context = hunkMatch[3].trim();
                        rows += `
                            <tr class="diff-row">
                                <td class="line-number">...</td>
                                <td class="line-number">...</td>
                                <td class="diff-content diff-header" colspan="2">
                                    ${this.escapeHtml(hunk.header)}
                                    ${context ? `<br><em>${this.escapeHtml(context)}</em>` : ''}
                                </td>
                            </tr>
                        `;
                    }

                    hunk.lines.forEach(line => {
                        const { type, content } = line;
                        let leftNum = '', rightNum = '', cssClass = '';

                        switch (type) {
                            case ' ':
                                leftNum = leftLine++;
                                rightNum = rightLine++;
                                cssClass = 'diff-context';
                                break;
                            case '-':
                                leftNum = leftLine++;
                                rightNum = '';
                                cssClass = 'diff-removed';
                                break;
                            case '+':
                                leftNum = '';
                                rightNum = rightLine++;
                                cssClass = 'diff-added';
                                break;
                        }

                        rows += `
                            <tr class="diff-row">
                                <td class="line-number">${leftNum}</td>
                                <td class="line-number">${rightNum}</td>
                                <td class="diff-content ${cssClass}" colspan="2">${this.escapeHtml(content)}</td>
                            </tr>
                        `;
                    });
                });

                return `
                    <table class="diff-table">
                        <thead>
                            <tr>
                                <th class="line-number" style="width: 50px;">Old</th>
                                <th class="line-number" style="width: 50px;">New</th>
                                <th style="text-align: left; padding: 8px;">Changes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                `;
            }

            addCopyListeners() {
                document.querySelectorAll('.copy-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const fileIndex = parseInt(e.target.dataset.fileIndex);
                        this.copyFileContent(fileIndex);
                    });
                });
            }

            async copyFileContent(fileIndex) {
                const fileSection = document.getElementById(`file-${fileIndex}`);
                if (!fileSection) return;

                const table = fileSection.querySelector('.diff-table');
                const rows = table.querySelectorAll('tbody tr');
                
                let content = '';
                rows.forEach(row => {
                    const cells = row.querySelectorAll('.diff-content');
                    cells.forEach(cell => {
                        content += cell.textContent + '\n';
                    });
                });

                try {
                    await navigator.clipboard.writeText(content);
                    
                    // Visual feedback
                    const btn = fileSection.querySelector('.copy-btn');
                    const originalText = btn.textContent;
                    btn.textContent = '‚úÖ Copied!';
                    btn.style.background = '#27ae60';
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 2000);
                    
                } catch (err) {
                    console.error('Copy failed:', err);
                    alert('Copy failed. Please try selecting and copying manually.');
                }
            }

            addNavigation(files) {
                // Smooth scrolling for navigation
                document.querySelectorAll('a[href^="#file-"]').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const target = document.querySelector(link.getAttribute('href'));
                        if (target) {
                            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    });
                });
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize the patch viewer
        document.addEventListener('DOMContentLoaded', () => {
            new PatchViewer();
        });
    </script>
</body>
</html>